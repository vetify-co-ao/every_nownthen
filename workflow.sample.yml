name: Kubernates CI/CD

on:
    push:
        tags: ["*"]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Create tag
              run: |
                  export TAG=$(date +%s)
                  echo "TAG=$TAG" >> $GITHUB_ENV
                  echo "IMAGE=zafircoao/vetify-portal:$TAG" >> $GITHUB_ENV
                  echo "HOME=/tmp" >> $GITHUB_ENV

            - name: Build container image
              run: docker build -f .build/container/Dockerfile -t "$IMAGE" .

            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Install doctl
              uses: digitalocean/action-doctl@v2
              with:
                  token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

            - name: Push image to repository
              run: docker push $IMAGE

            - name: Update deployment file with image
              run: sed -i "s|<IMAGE>|$IMAGE|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with antbox server
              run: sed -i "s|<ANTBOX_URL>|${{ vars.ANTBOX_URL }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with antbox tenant
              run: sed -i "s|<ANTBOX_TENANT>|${{ vars.ANTBOX_TENANT }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with auth url
              run: sed -i "s|<AUTH_URL>|${{ vars.AUTH_URL }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with auth client id
              run: sed -i "s|<AUTH_CLIENT_ID>|${{ vars.AUTH_CLIENT_ID }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with enrollment email
              run: sed -i "s|<EMAIL_TO_SEND_ENROLLMENT>|${{ vars.EMAIL_TO_SEND_ENROLLMENT }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with app url
              run: sed -i "s|<APP_URL>|${{ vars.APP_URL }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Update deployment file with google key path
              run: sed -i "s|<GOOGLE_KEY_PATH>|${{ vars.GOOGLE_KEY_PATH }}|" $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Save DigitalOcean kubeconfig with short-lived credentials
              run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 ${{ vars.DIGITALOCEAN_K8S_CLUSTER_NAME }}

            - name: Deploy to DigitalOcean Kubernetes
              run: kubectl apply -f $GITHUB_WORKSPACE/.deployments/k8s/deployment.yaml

            - name: Verify deployment
              run: kubectl -n vetify rollout status deployment/portal
